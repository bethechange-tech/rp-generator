exports.id=120,exports.ids=[120],exports.modules={16874:(a,b,c)=>{"use strict";c.d(b,{o:()=>f});var d=c(19369);let e=null;function f(){return e||(e=new d.cf({endpoint:process.env.S3_ENDPOINT||"http://localhost:9000",region:process.env.S3_REGION||"us-east-1",accessKeyId:process.env.S3_ACCESS_KEY||"minioadmin",secretAccessKey:process.env.S3_SECRET_KEY||"minioadmin",bucket:process.env.S3_BUCKET||"receipts"})),e}},19369:(a,b,c)=>{"use strict";b.cf=void 0;var d=c(81894);Object.defineProperty(b,"cf",{enumerable:!0,get:function(){return d.ReceiptQueryService}}),c(80286)},28785:(a,b,c)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0}),b.ReceiptQueryService=void 0;let d=c(91043),e=c(65487);class f{constructor(a=100,b=300){this.cache=new Map,this.maxSize=a,this.ttlMs=1e3*b}get(a){let b=this.cache.get(a);if(b)return Date.now()>b.expiry?void this.cache.delete(a):(this.cache.delete(a),this.cache.set(a,b),b.value)}set(a,b){if(this.cache.size>=this.maxSize){let a=this.cache.keys().next().value;a&&this.cache.delete(a)}this.cache.set(a,{value:b,expiry:Date.now()+this.ttlMs})}clear(){this.cache.clear()}get size(){return this.cache.size}}class g{constructor(a){this.bucket=a.bucket,this.enableCache=a.enableCache??!0,this.maxConcurrency=a.maxConcurrency??5,this.cache=new f(a.cacheSize??100,a.cacheTtlSeconds??300),this.client=new d.S3Client({endpoint:a.endpoint,region:a.region,credentials:{accessKeyId:a.accessKeyId,secretAccessKey:a.secretAccessKey},forcePathStyle:!0})}async query(a){let b,c=this.getDateRange(a.date_from,a.date_to),d=Math.min(a.limit??50,100),e=this.parseCursor(a.cursor),f=await this.parallelScan(c,a);f.sort((a,b)=>{let c=b.payment_date.localeCompare(a.payment_date);return 0!==c?c:b.session_id.localeCompare(a.session_id)});let g=0;e&&(-1===(g=f.findIndex(a=>a.payment_date===e.date&&a.session_id===e.sessionId))?g=0:g+=1);let h=f.length,i=f.slice(g,g+d),j=g+d<h;if(j&&i.length>0){let a=i[i.length-1];b=`${a.payment_date}:${a.session_id}`}return{records:i,scanned_dates:c,total_count:h,next_cursor:b,has_more:j,page_size:d}}async parallelScan(a,b){let c=[];for(let d=0;d<a.length;d+=this.maxConcurrency){let e=a.slice(d,d+this.maxConcurrency);for(let a of(await Promise.all(e.map(a=>this.queryDateWithCache(a,b)))))c.push(...a)}return c}async queryDateWithCache(a,b){let c=`index/dt=${a}/index.ndjson`,d=this.buildCacheKey(a,b);if(this.enableCache){let a=this.cache.get(d);if(a)return a}try{let a=await this.queryIndexFile(c,b);return this.enableCache&&this.cache.set(d,a),a}catch(a){return"NoSuchKey"!==a.name&&console.warn(`Failed to query ${c}:`,a.message),[]}}buildCacheKey(a,b){return[a,b.session_id||"",b.consumer_id||"",b.card_last_four||"",b.receipt_number||"",b.amount_min?.toString()||"",b.amount_max?.toString()||""].join("|")}parseCursor(a){if(!a)return null;let[b,...c]=a.split(":"),d=c.join(":");return b&&d?{date:b,sessionId:d}:null}clearCache(){this.cache.clear()}getCacheStats(){return{size:this.cache.size,enabled:this.enableCache}}async queryIndexFile(a,b){try{return await this.queryWithS3Select(a,b)}catch(c){return await this.queryWithClientFilter(a,b)}}async queryWithS3Select(a,b){let c=this.buildSqlQuery(b),e=new d.SelectObjectContentCommand({Bucket:this.bucket,Key:a,ExpressionType:"SQL",Expression:c,InputSerialization:{JSON:{Type:"LINES"}},OutputSerialization:{JSON:{}}}),f=await this.client.send(e),g=[];if(f.Payload){for await(let a of f.Payload)if(a.Records?.Payload)for(let b of new TextDecoder().decode(a.Records.Payload).split("\n").filter(Boolean))g.push(JSON.parse(b))}return g}async queryWithClientFilter(a,b){let c=await this.client.send(new d.GetObjectCommand({Bucket:this.bucket,Key:a}));return(await c.Body?.transformToString()||"").split("\n").filter(Boolean).map(a=>JSON.parse(a)).filter(a=>this.matchesQuery(a,b))}matchesQuery(a,b){if(b.session_id&&a.session_id!==b.session_id||b.consumer_id&&a.consumer_id!==b.consumer_id||b.card_last_four&&a.card_last_four!==b.card_last_four||b.receipt_number&&a.receipt_number!==b.receipt_number)return!1;if(b.amount_min||b.amount_max){let c=parseFloat(a.amount.replace(/[^0-9.]/g,""));if(b.amount_min&&c<b.amount_min||b.amount_max&&c>b.amount_max)return!1}return!0}buildSqlQuery(a){let b=[];a.session_id&&b.push(`s.session_id = '${a.session_id}'`),a.consumer_id&&b.push(`s.consumer_id = '${a.consumer_id}'`),a.card_last_four&&b.push(`s.card_last_four = '${a.card_last_four}'`),a.receipt_number&&b.push(`s.receipt_number = '${a.receipt_number}'`);let c=b.length>0?` WHERE ${b.join(" AND ")}`:"";return`SELECT * FROM s3object s${c}`}getDateRange(a,b){let c=b?new Date(b):new Date,d=new Date(a||c);a||b||d.setDate(d.getDate()-7);let e=[],f=new Date(d);for(;f<=c;)e.push(f.toISOString().split("T")[0]),f.setDate(f.getDate()+1);return e}async getPdf(a){let b=await this.client.send(new d.GetObjectCommand({Bucket:this.bucket,Key:a})),c=await b.Body?.transformToByteArray();return Buffer.from(c||[])}async getPdfBase64(a){return(await this.getPdf(a)).toString("base64")}async getSignedPdfUrl(a,b=3600){let c=new d.GetObjectCommand({Bucket:this.bucket,Key:a,ResponseContentType:"application/pdf"});return(0,e.getSignedUrl)(this.client,c,{expiresIn:b})}static createLocal(a){return new g({endpoint:"http://localhost:9000",region:"us-east-1",accessKeyId:"minioadmin",secretAccessKey:"minioadmin",bucket:"receipts",...a})}}b.ReceiptQueryService=g},44237:(a,b,c)=>{"use strict";var d=Object.create?function(a,b,c,d){void 0===d&&(d=c);var e=Object.getOwnPropertyDescriptor(b,c);(!e||("get"in e?!b.__esModule:e.writable||e.configurable))&&(e={enumerable:!0,get:function(){return b[c]}}),Object.defineProperty(a,d,e)}:function(a,b,c,d){void 0===d&&(d=c),a[d]=b[c]},e=Object.create?function(a,b){Object.defineProperty(a,"default",{enumerable:!0,value:b})}:function(a,b){a.default=b},f=function(){var a=function(b){return(a=Object.getOwnPropertyNames||function(a){var b=[];for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[b.length]=c);return b})(b)};return function(b){if(b&&b.__esModule)return b;var c={};if(null!=b)for(var f=a(b),g=0;g<f.length;g++)"default"!==f[g]&&d(c,b,f[g]);return e(c,b),c}}();Object.defineProperty(b,"__esModule",{value:!0}),b.FileTemplateProvider=void 0;let g=f(c(29021)),h=f(c(33873));class i{constructor(a){this.templateDir=a}getHtmlTemplate(){let a=h.join(this.templateDir,"html","index.html");return g.readFileSync(a,"utf-8")}getCss(){let a=h.join(this.templateDir,"css","styles.css");return g.readFileSync(a,"utf-8")}}b.FileTemplateProvider=i},60499:(a,b,c)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0}),b.PuppeteerPdfRenderer=void 0;let d=function(a){return a&&a.__esModule?a:{default:a}}(c(40758));class e{constructor(){this.pdfOptions={format:"A4",printBackground:!0,margin:{top:"10mm",bottom:"10mm",left:"10mm",right:"10mm"}}}async render(a,b){let c=await d.default.launch(),e=await c.newPage();await e.setContent(a,{waitUntil:"networkidle0"}),await e.pdf({path:b,...this.pdfOptions}),await c.close()}async renderToBase64(a){let b=await d.default.launch(),c=await b.newPage();await c.setContent(a,{waitUntil:"networkidle0"});let e=await c.pdf(this.pdfOptions);return await b.close(),Buffer.from(e).toString("base64")}}b.PuppeteerPdfRenderer=e},80286:(a,b,c)=>{"use strict";var d=Object.create?function(a,b,c,d){void 0===d&&(d=c);var e=Object.getOwnPropertyDescriptor(b,c);(!e||("get"in e?!b.__esModule:e.writable||e.configurable))&&(e={enumerable:!0,get:function(){return b[c]}}),Object.defineProperty(a,d,e)}:function(a,b,c,d){void 0===d&&(d=c),a[d]=b[c]},e=Object.create?function(a,b){Object.defineProperty(a,"default",{enumerable:!0,value:b})}:function(a,b){a.default=b},f=function(){var a=function(b){return(a=Object.getOwnPropertyNames||function(a){var b=[];for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[b.length]=c);return b})(b)};return function(b){if(b&&b.__esModule)return b;var c={};if(null!=b)for(var f=a(b),g=0;g<f.length;g++)"default"!==f[g]&&d(c,b,f[g]);return e(c,b),c}}();Object.defineProperty(b,"__esModule",{value:!0}),b.ReceiptPdfGenerator=void 0;let g=f(c(33873)),h=c(81894);class i{constructor(a,b){this.templateProvider=a,this.pdfRenderer=b}async generate(a,b){let c=this.buildHtml(a);await this.pdfRenderer.render(c,b),console.log(`PDF generated: ${b}`)}async generateBase64(a){let b=this.buildHtml(a),c=await this.pdfRenderer.renderToBase64(b);return console.log(`PDF generated as base64 (${c.length} chars)`),c}buildHtml(a){let b=this.templateProvider.getHtmlTemplate(),c=this.templateProvider.getCss(),d=this.populateTemplate(b,a);return this.inlineCss(d,c)}populateTemplate(a,b){let c=a;for(let[a,d]of(b.discount_amount&&"$0.00"!==b.discount_amount&&"0"!==b.discount_amount||(c=c.replace(/<div class="cost-row discount">[\s\S]*?<\/div>/,"")),Object.entries({...b,qr_code_svg:b.qr_code_svg||i.DEFAULT_QR_CODE,company_logo_svg:b.company_logo_svg||i.DEFAULT_LOGO,discount_label:b.discount_label||"",discount_percent:b.discount_percent||"",discount_amount:b.discount_amount||""}))){let b=RegExp(`{{${a}}}`,"g");c=c.replace(b,d)}return c}inlineCss(a,b){return a.replace('<link rel="stylesheet" href="../css/styles.css">',`<style>${b}</style>`)}static create(a){let b=a||g.join(__dirname,"..","..","template");return new i(new h.FileTemplateProvider(b),new h.PuppeteerPdfRenderer)}}b.ReceiptPdfGenerator=i,i.DEFAULT_QR_CODE=`<svg width="80" height="80" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
    <rect width="80" height="80" fill="white"/>
    <rect x="8" y="8" width="20" height="20" stroke="#000" stroke-width="2" fill="none"/>
    <rect x="12" y="12" width="12" height="12" fill="#000"/>
    <rect x="52" y="8" width="20" height="20" stroke="#000" stroke-width="2" fill="none"/>
    <rect x="56" y="12" width="12" height="12" fill="#000"/>
    <rect x="8" y="52" width="20" height="20" stroke="#000" stroke-width="2" fill="none"/>
    <rect x="12" y="56" width="12" height="12" fill="#000"/>
  </svg>`,i.DEFAULT_LOGO=`<svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
    <circle cx="30" cy="30" r="28" stroke="#10b981" stroke-width="3" fill="#ecfdf5"/>
    <path d="M32 18L22 32H28L26 42L38 28H31L32 18Z" fill="#10b981" stroke="#10b981" stroke-width="1" stroke-linejoin="round"/>
  </svg>`},80408:()=>{},81894:(a,b,c)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0}),b.ReceiptQueryService=b.S3ReceiptStorage=b.PuppeteerPdfRenderer=b.FileTemplateProvider=void 0;var d=c(44237);Object.defineProperty(b,"FileTemplateProvider",{enumerable:!0,get:function(){return d.FileTemplateProvider}});var e=c(60499);Object.defineProperty(b,"PuppeteerPdfRenderer",{enumerable:!0,get:function(){return e.PuppeteerPdfRenderer}});var f=c(92599);Object.defineProperty(b,"S3ReceiptStorage",{enumerable:!0,get:function(){return f.S3ReceiptStorage}});var g=c(28785);Object.defineProperty(b,"ReceiptQueryService",{enumerable:!0,get:function(){return g.ReceiptQueryService}})},87032:()=>{},92599:(a,b,c)=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0}),b.S3ReceiptStorage=void 0;let d=c(91043);class e{constructor(a){this.bucket=a.bucket,this.client=new d.S3Client({endpoint:a.endpoint,region:a.region,credentials:{accessKeyId:a.accessKeyId,secretAccessKey:a.secretAccessKey},forcePathStyle:!0})}async storeReceipt(a,b){let c=b.session_id,d=b.payment_date,e=`pdfs/${c}.pdf`,f=`metadata/${c}.json`,g=`index/dt=${d}/index.ndjson`,h=[],i=null;try{await this.uploadPdf(a,e),h.push(e);let d={...b,pdf_key:e,metadata_key:f,created_at:new Date().toISOString()};return await this.uploadMetadata(d,f),h.push(f),i=await this.getIndexContent(g),await this.appendToIndex(d,g,i),console.log(`Receipt stored: ${c}`),{pdf_key:e,metadata_key:f,index_key:g}}catch(a){throw console.error("Transaction failed, rolling back..."),await this.rollback(h,g,i),a}}async rollback(a,b,c){for(let b of a)try{await this.client.send(new d.DeleteObjectCommand({Bucket:this.bucket,Key:b})),console.log(`  Rolled back: ${b}`)}catch(a){console.error(`  Failed to rollback ${b}:`,a.message)}if(null!==c)try{await this.client.send(new d.PutObjectCommand({Bucket:this.bucket,Key:b,Body:c,ContentType:"application/x-ndjson"})),console.log(`  Rolled back index: ${b}`)}catch(a){console.error("  Failed to rollback index:",a.message)}}async uploadPdf(a,b){let c=Buffer.from(a,"base64");await this.client.send(new d.PutObjectCommand({Bucket:this.bucket,Key:b,Body:c,ContentType:"application/pdf"})),console.log(`  PDF: ${b}`)}async uploadMetadata(a,b){await this.client.send(new d.PutObjectCommand({Bucket:this.bucket,Key:b,Body:JSON.stringify(a,null,2),ContentType:"application/json"})),console.log(`  Metadata: ${b}`)}async getIndexContent(a){try{let b=await this.client.send(new d.GetObjectCommand({Bucket:this.bucket,Key:a}));return await b.Body?.transformToString()||""}catch(a){if("NoSuchKey"===a.name)return null;throw a}}async appendToIndex(a,b,c){let e=JSON.stringify(a),f=c?`${c}
${e}`:e;await this.client.send(new d.PutObjectCommand({Bucket:this.bucket,Key:b,Body:f,ContentType:"application/x-ndjson"})),console.log(`  Index: ${b}`)}static createLocal(){return new e({endpoint:"http://localhost:9000",region:"us-east-1",accessKeyId:"minioadmin",secretAccessKey:"minioadmin",bucket:"receipts"})}}b.S3ReceiptStorage=e}};